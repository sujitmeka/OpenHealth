# HealthAI Build Progress

## Codebase Patterns

<!-- Ralph adds reusable patterns here as discovered -->

---

## Build Log

<!-- Ralph appends completed stories below -->

---
## 2024-01-12 - US-016: Sample data files

**Implemented:**
- Created data/sample-bloodwork.txt with all 9 Levine PhenoAge biomarkers + lipid panel + additional markers
- Created data/sample-dexa.txt with body composition, visceral fat, bone density, ALMI
- Created data/sample-whoop.csv with 7 days of HRV, RHR, sleep data

**Files created:**
- data/sample-bloodwork.txt
- data/sample-dexa.txt
- data/sample-whoop.csv

**Learnings:**
- Bloodwork format: "Biomarker: value unit (Reference: range)" is easy to parse with regex
- DEXA includes multiple T-scores (lumbar, hip, whole body)
- Whoop CSV uses snake_case headers: date,hrv_ms,rhr_bpm,sleep_hours,sleep_score,strain

**Verified:**
- [x] All files exist in /data folder
- [x] Bloodwork contains all 9 PhenoAge inputs: albumin, creatinine, glucose, CRP, lymphocyte %, MCV, RDW, ALP, WBC
- [x] Values realistic for healthy 35-year-old

---
## 2024-01-12 - US-001: Project scaffolding

**Implemented:**
- Next.js 16 app with App Router and src directory
- Tailwind CSS v4 configured
- shadcn/ui initialized with components.json
- TypeScript strict mode enabled
- Added typecheck script to package.json

**Files created:**
- src/app/page.tsx, layout.tsx, globals.css
- src/lib/utils.ts (shadcn)
- tsconfig.json, next.config.ts, postcss.config.mjs
- components.json (shadcn config)
- package.json with scripts

**Learnings:**
- Next.js 16 now uses Turbopack by default
- Tailwind v4 uses different config format (postcss.config.mjs)
- Need to reinstall node_modules after copying from subdirectory (broken symlinks)

**Verified:**
- [x] typecheck passes
- [x] dev server runs (HTTP 200)
- [x] localhost:3000 shows default Next.js page

---
## 2024-01-12 - US-002: Data folder structure and file detection

**Implemented:**
- src/lib/files.ts with getDataFiles() function
- Returns array of {name, type, path, extension} for files in /data
- Type detection based on filename patterns (bloodwork, dexa, activity)
- Supports .txt, .csv, .xlsx extensions
- Console logs detected files on startup

**Files created:**
- src/lib/files.ts

**Learnings:**
- Pattern: Use filename includes() for type detection (blood/lab/metabolic -> bloodwork)
- Return 'unknown' type for unrecognized files
- Log format: "[HealthAI] Detected data files: [...]"

**Verified:**
- [x] typecheck passes
- [x] Console logs: sample-bloodwork.txt (bloodwork), sample-dexa.txt (dexa), sample-whoop.csv (activity)

---
## 2024-01-12 - US-003: Text file parsing

**Implemented:**
- src/lib/parsers/text.ts with parseTextFile(path) function
- Uses fs.readFileSync with utf-8 encoding
- Returns empty string and logs error on failure

**Files created:**
- src/lib/parsers/text.ts

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-004: CSV parsing

**Implemented:**
- Installed papaparse and @types/papaparse
- src/lib/parsers/csv.ts with parseCsv(path) function
- Uses Papa.parse with header: true, dynamicTyping: true
- Returns array of objects with column names as keys

**Files created:**
- src/lib/parsers/csv.ts

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-005: XLSX parsing

**Implemented:**
- Installed xlsx package
- src/lib/parsers/xlsx.ts with parseXlsx(path) function
- Returns array of {name, data} per sheet
- Uses XLSX.utils.sheet_to_json for conversion

**Files created:**
- src/lib/parsers/xlsx.ts

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-006: Biomarker extraction from text

**Implemented:**
- src/lib/extractors/biomarkers.ts with extractBiomarkers(text) function
- Extracts all 9 Levine PhenoAge inputs using regex patterns
- Also extracts lipid panel (LDL, HDL, triglycerides) and vitamin D
- hasAllPhenoAgeInputs() helper to validate required biomarkers
- Handles multiple name variations per biomarker

**Files created:**
- src/lib/extractors/biomarkers.ts

**Learnings:**
- Pattern: Use array of regex patterns per biomarker, first match wins
- Handle variations like "C-Reactive Protein" vs "CRP" vs "hs-CRP"
- Extract patient age from text for PhenoAge calculation

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-007: Levine PhenoAge calculation

**Implemented:**
- src/lib/calculations/phenoage.ts with calculatePhenoAge(biomarkers, chronologicalAge)
- Three-step formula: calculate xb (linear combination), calculate m (mortality risk), calculate PhenoAge
- Returns {phenoAge, delta} or null if missing required biomarkers
- Handles CRP <= 0 edge case by using 0.01
- Rounds to 1 decimal place

**Files created:**
- src/lib/calculations/phenoage.ts

**Learnings:**
- Formula coefficients from Levine et al. (2018) paper
- gamma constant = 0.0077
- Use Math.log for natural log in JavaScript

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-008: Health data store

**Implemented:**
- src/lib/store/health-data.ts with HealthDataStore singleton
- src/lib/extractors/body-comp.ts for DEXA data extraction
- Methods: loadAllData(), getBiomarkers(), getBodyComp(), getActivity(), getPhenoAge(), getHealthSummary()
- Coordinates all parsers and extractors
- getHealthSummary() returns formatted text for agent context

**Files created:**
- src/lib/store/health-data.ts
- src/lib/extractors/body-comp.ts

**Learnings:**
- Singleton pattern: export instance of class
- Lazy loading: ensureLoaded() calls loadAllData() if not loaded
- Activity data averages useful for summary

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-009: Dashboard layout shell

**Implemented:**
- Replaced default Next.js page with HealthAI dashboard
- Header with title, Sync Data button, and age placeholders
- 3-column responsive grid (1 col mobile, 2 col tablet, 3 col desktop)
- Blood Work, DEXA Scan, Activity cards using shadcn/ui
- Areas to Improve section
- Chat section at bottom with placeholder

**Files modified:**
- src/app/page.tsx
- Added src/components/ui/card.tsx (via shadcn)

**Learnings:**
- Tailwind responsive: grid-cols-1 md:grid-cols-2 lg:grid-cols-3
- shadcn Card has CardHeader, CardTitle, CardDescription, CardContent

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-010: Dashboard data integration

**Implemented:**
- src/lib/types/health.ts with reference ranges and status functions
- Dashboard loads real data from HealthDataStore
- Header shows chronological age, biological age, and delta (color-coded)
- Blood Work card displays all biomarkers with color-coded status
- DEXA card shows body composition metrics
- Activity card shows 7-day averages for HRV, RHR, sleep
- Graceful "No data" display when data missing

**Files created:**
- src/lib/types/health.ts

**Files modified:**
- src/app/page.tsx

**Learnings:**
- Reference ranges from HEALTH_KNOWLEDGE.md encoded as constants
- Status logic: check optimal first, then normal, then borderline (10% buffer)
- Color classes: green for optimal/normal, yellow for borderline, red for out of range

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-011: Areas to Improve logic

**Implemented:**
- src/lib/analysis/improvements.ts with getImprovements(biomarkers, bodyComp)
- Returns array of improvements sorted by severity
- Compares against optimal ranges (not just normal)
- Recommendations from HEALTH_KNOWLEDGE.md encoded as constants
- Dashboard renders improvements with color-coded backgrounds
- Shows encouraging message when all biomarkers optimal

**Files created:**
- src/lib/analysis/improvements.ts

**Files modified:**
- src/app/page.tsx

**Learnings:**
- Sort improvements by severity: out_of_range > borderline > normal
- Use getStatusBgColor for card backgrounds
- Target values formatted as ranges or thresholds

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-012: Claude Agent SDK setup

**Implemented:**
- Installed @anthropic-ai/claude-agent-sdk
- Created lib/agent/health-agent.ts with queryHealthAgent() and createHealthAgent()
- Health-focused system prompt with reference ranges, verified sources, response guidelines
- Allowed tools: Read, Bash, WebSearch, WebFetch
- Medical disclaimer included in system prompt
- Handles BetaMessage content extraction properly

**Files created:**
- src/lib/agent/health-agent.ts

**Learnings:**
- SDK returns SDKAssistantMessage with msg.message.content (BetaMessage)
- Content is array of blocks, need to filter for type='text'
- Use permissionMode: 'default' and maxBudgetUsd for safety

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-013: Chat API route

**Implemented:**
- Created app/api/chat/route.ts with POST handler
- Accepts JSON body { message: string }
- Validates message (required, non-empty string)
- Loads health context from HealthDataStore.getHealthSummary()
- Calls queryHealthAgent with message and context
- Returns { response: string } on success
- Error handling: 400 for bad input, 500 for agent errors

**Files created:**
- src/app/api/chat/route.ts

**Learnings:**
- Next.js App Router uses route.ts with exported HTTP method functions
- Use NextRequest/NextResponse for typed request/response

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-014: Chat UI component

**Implemented:**
- Created components/Chat.tsx as client component ('use client')
- Text input field with send button (shadcn Input, Button)
- Message history with alternating user/assistant bubbles
- Loading indicator with bouncing dots animation
- Auto-scroll to latest message using useRef
- Integrated into dashboard page.tsx
- Fetches to /api/chat on submit
- Error handling with inline error display

**Files created:**
- src/components/Chat.tsx
- src/components/ui/input.tsx (via shadcn)
- src/components/ui/button.tsx (via shadcn)

**Files modified:**
- src/app/page.tsx

**Learnings:**
- Use 'use client' for components with React hooks
- useRef for auto-scroll to messagesEndRef div
- Animate loading dots with tailwind animate-bounce and animationDelay

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-015: Data sync on startup and manual resync

**Implemented:**
- App loads data on startup via HealthDataStore lazy loading
- SyncButton client component with loading state
- /api/sync POST endpoint to re-scan /data folder
- Sonner toast for success/error feedback
- Page reloads after successful sync to show updated data
- Layout includes Toaster component

**Files created:**
- src/components/SyncButton.tsx
- src/app/api/sync/route.ts
- src/components/ui/sonner.tsx (via shadcn)

**Files modified:**
- src/app/layout.tsx (add Toaster, update metadata)
- src/app/page.tsx (use SyncButton)

**Learnings:**
- Use sonner for toast notifications (shadcn wrapper)
- Toaster goes in layout.tsx for app-wide availability
- window.location.reload() to refresh server component data

**Verified:**
- [x] typecheck passes

---
## BUILD COMPLETE

All 16 user stories have been implemented:
- US-016: Sample data files (priority 0)
- US-001: Project scaffolding (priority 1)
- US-002: Data folder structure and file detection (priority 2)
- US-003: Text file parsing (priority 3)
- US-004: CSV parsing (priority 4)
- US-005: XLSX parsing (priority 5)
- US-006: Biomarker extraction from text (priority 6)
- US-007: Levine PhenoAge calculation (priority 7)
- US-008: Health data store (priority 8)
- US-009: Dashboard layout shell (priority 9)
- US-010: Dashboard data integration (priority 10)
- US-011: Areas to Improve logic (priority 11)
- US-012: Claude Agent SDK setup (priority 12)
- US-013: Chat API route (priority 13)
- US-014: Chat UI component (priority 14)
- US-015: Data sync on startup and manual resync (priority 15)

---
## 2025-01-13 - DT-001: Install Three.js dependencies

**Implemented:**
- Installed three@0.182.0 for 3D rendering
- Installed @react-three/fiber@9.5.0 for React integration
- Installed @react-three/drei@10.7.7 for helpers (OrbitControls, etc.)
- Installed @types/three@0.182.0 for TypeScript support

**Files modified:**
- package.json (dependencies added)
- package-lock.json

**Three.js learnings:**
- three is the core library
- @react-three/fiber provides React component wrapper for Three.js
- @react-three/drei provides useful helpers like OrbitControls, ContactShadows

**Verified:**
- [x] typecheck passes
- [x] dev server runs without errors

---
## 2025-01-13 - DT-002: Basic Three.js canvas component

**Implemented:**
- Created src/components/digital-twin/TwinCanvas.tsx
- Canvas with soft gray gradient background (CSS linear gradient)
- Three-point lighting: ambient (0.6), directional main (0.8), rim light (0.3)
- OrbitControls with pan disabled, zoom limited, angle constrained
- Camera at [0, 1.5, 4] looking at [0, 1, 0] for human-height view
- Test box mesh for verification
- Semi-transparent ground plane

**Files created:**
- src/components/digital-twin/TwinCanvas.tsx
- src/app/twin-test/page.tsx (test page)

**Three.js learnings:**
- Canvas component needs explicit dimensions (parent container or CSS)
- OrbitControls target sets the focal point for rotation
- minPolarAngle/maxPolarAngle constrains vertical rotation
- Shadow rendering requires castShadow on lights and receiveShadow on meshes

**Verified:**
- [x] typecheck passes
- [x] renders in browser at /twin-test
- [x] gray gradient background visible
- [x] test box renders with proper lighting

---
## 2025-01-13 - DT-003: Procedural human body - torso and head

**Implemented:**
- Created src/components/digital-twin/ProceduralHuman.tsx
- Head as SphereGeometry (radius 0.12)
- Neck as CylinderGeometry connecting head to torso
- Torso as two CapsuleGeometry parts (chest + abdomen)
- Light gray material (#f0f0f0) for mannequin look
- Body positioned so feet will be at Y=0
- castShadow enabled on all meshes

**Files created:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- CapsuleGeometry args: [radius, length, capSegments, radialSegments]
- Use nested groups for hierarchical body parts
- Position offset (bodyOffset) used to ground the figure

**Verified:**
- [x] typecheck passes
- [x] renders in browser
- [x] head, neck, torso visible with proper proportions

---
## 2025-01-13 - DT-004: Procedural human body - arms

**Implemented:**
- Added Arm component with side prop ('left' | 'right')
- Shoulder joint as small sphere
- Upper arm as capsule (radius 0.04, length 0.2)
- Elbow joint as sphere
- Forearm as capsule (radius 0.035, length 0.18)
- Hand as sphere
- Hierarchical grouping: shoulder → upper arm → elbow → forearm → hand
- Arms hang naturally at sides with slight outward angle

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- xSign pattern for mirroring left/right limbs
- Group rotation allows whole limb to rotate from shoulder
- Nested groups enable joint rotations (elbow bends relative to upper arm)

**Verified:**
- [x] typecheck passes
- [x] renders in browser
- [x] both arms visible at sides of torso

---
## 2025-01-13 - DT-005: Procedural human body - legs

**Implemented:**
- Added Leg component with side prop ('left' | 'right')
- Hip joint as sphere
- Thigh as capsule (radius 0.055, length 0.28)
- Knee joint as sphere
- Shin as capsule (radius 0.04, length 0.28)
- Foot as box (flat, extends forward)
- Hierarchical grouping: hip → thigh → knee → shin → foot
- Legs positioned close together under pelvis

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- BoxGeometry for flat feet [width, height, depth]
- Foot offset in Z direction to extend forward naturally
- Full body height ~1.8 units with bodyOffset=0.9

**Verified:**
- [x] typecheck passes
- [x] renders in browser
- [x] full mannequin body visible with proper proportions
- [x] feet touch ground plane

---
## 2025-01-13 - DT-006: Body state types and interface

**Implemented:**
- Created src/lib/digital-twin/types.ts
- BodyState interface: posture, energyLevel, skinTone, highlights
- PostureState type: 'upright' | 'slouched' | 'fatigued' | 'neutral'
- HighlightRegion: { area, color, intensity }
- HighlightArea union type for body regions
- DEFAULT_BODY_STATE constant
- HIGHLIGHT_COLORS and VITALITY_TONES constants
- Updated ProceduralHuman to accept bodyState prop

**Files created:**
- src/lib/digital-twin/types.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- Separating state types from components enables clean data flow
- Console logging body state helps debug health→visual mapping

**Verified:**
- [x] typecheck passes
- [x] renders in browser
- [x] console logs body state

---
## 2025-01-13 - DT-007: Health to body state mapper

**Implemented:**
- Created src/lib/digital-twin/mapper.ts
- mapHealthToBodyState(healthData) function
- calculateAverageSleepScore() - from activity data or sleep hours
- calculateAverageHrv() - from activity data
- calculateEnergyLevel() - weighted 60% sleep, 40% HRV
- determinePosture() - maps energy/HRV to PostureState
- determineSkinTone() - maps energy to VITALITY_TONES
- calculateHighlights() - visceral fat→torso, CRP→joints

**Thresholds:**
- Visceral fat: >2.0 critical, >1.5 warning, >1.0 mild
- CRP: >3.0 critical (all joints), >2.0 warning (knees), >1.0 mild
- Energy: ≥75 upright, ≥55 neutral, ≥35 slouched, <35 fatigued

**Files created:**
- src/lib/digital-twin/mapper.ts

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-008: Posture system - joint rotations

**Implemented:**
- Created src/lib/digital-twin/posture.ts
- getPostureRotations(energyLevel, postureState) function
- Returns: spineX, neckX, shoulderZ, headX in radians
- Posture presets for upright/neutral/slouched/fatigued
- getArmRotations(energyLevel) for shoulder adjustment
- Updated ProceduralHuman to apply rotations
- Added rotation props to Head, Neck, Arm components
- Test page with energy slider to demo posture changes

**Rotation values (radians):**
- Upright: 0 on all axes
- Fatigued: spineX=0.25, neckX=0.18, headX=0.15, shoulderZ=0.12

**Files created:**
- src/lib/digital-twin/posture.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx
- src/app/twin-test/page.tsx

**Three.js learnings:**
- Group rotation affects all children (spine rotation cascades)
- Separate upper body rotation from legs for realistic posture

**Verified:**
- [x] typecheck passes
- [x] posture rotations calculated correctly

---
## 2025-01-13 - DT-009: Region highlighting system

**Implemented:**
- Created src/lib/digital-twin/highlights.ts
- BODY_REGIONS mapping areas to component names
- getHighlightForRegion() - finds highlight for area
- getEmissiveProps() - returns emissive color and intensity
- isRegionHighlighted() - checks if area is highlighted
- getMaterialProps() helper in ProceduralHuman
- Added highlights prop to Torso, Arm, Leg components
- Emissive materials applied to: torso, shoulders, elbows, hips, knees

**Highlight areas:**
- torso-core, left/right-shoulder, left/right-elbow
- left/right-hip, left/right-knee, head

**Files created:**
- src/lib/digital-twin/highlights.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- meshStandardMaterial accepts emissive (color) and emissiveIntensity (0-1)
- Spread props: {...materialProps} applies all properties

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-010: Skin tone and vitality visuals

**Implemented:**
- Created src/lib/digital-twin/vitality.ts
- getVitalityColor(energyLevel) - calculates HSL-based color from energy
- hslToHex() helper for HSL to hex conversion
- lerp() helper for linear interpolation
- VITALITY_PRESETS for quick reference colors

**Color mapping:**
- High energy (100): warm white hsl(30, 10%, 92%)
- Low energy (0): cool gray hsl(220, 5%, 80%)
- Smooth interpolation between values

**Changes to ProceduralHuman:**
- Import getVitalityColor from vitality.ts
- Calculate vitalityColor based on energyLevel
- Pass vitalityColor to all sub-components (Head, Neck, Torso, Arm, Leg)
- All body parts now use vitality color as base material color

**Files created:**
- src/lib/digital-twin/vitality.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**HSL learnings:**
- HSL easier than RGB for intuitive color manipulation
- Hue 30 = warm/orange, Hue 220 = cool/blue
- Small saturation changes (5-10%) keep mannequin look

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-011: Wire digital twin to health data

**Implemented:**
- Created src/components/digital-twin/DigitalTwin.tsx
- Main wrapper that connects HealthDataStore to ProceduralHuman
- Uses useMemo to compute bodyState from health data
- Calls mapHealthToBodyState with biomarkers, bodyComp, activity
- Console logs health input and mapped state for debugging
- Falls back to DEFAULT_BODY_STATE on error

**Data flow:**
HealthDataStore → HealthDataInput → mapHealthToBodyState → BodyState → ProceduralHuman

**Files created:**
- src/components/digital-twin/DigitalTwin.tsx

**Learnings:**
- useMemo for expensive computations that don't change often
- Error handling with fallback state for robustness

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-012: Integrate into dashboard layout

**Implemented:**
- Added DigitalTwin import to main page.tsx
- Created 2-column grid layout (lg breakpoint)
- Twin on left (lg:row-span-2), stats cards on right
- Twin container: min-h-[400px] aspect-[4/5]
- Stats cards in responsive sub-grid
- Mobile stacks vertically

**Layout structure:**
- Main grid: lg:grid-cols-2
- Digital Twin card spans 2 rows on lg
- Stats cards (Blood Work, DEXA, Activity) stacked on right
- Areas to Improve and Chat sections below

**Files modified:**
- src/app/page.tsx

**CSS learnings:**
- lg:row-span-2 makes twin tall enough for stats cards
- aspect-[4/5] maintains proportions without content shift
- min-h-[400px] ensures minimum visibility

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-013: Smooth animation transitions

**Implemented:**
- Created src/lib/digital-twin/animation.ts
- lerpValue() - smooth number interpolation using exponential decay
- lerpPosture() - animate all posture rotations together
- lerpColor() - smooth Three.js Color interpolation
- AnimatedPosture interface for type-safe animation state
- ANIMATION_SPEED constant (2.0) for ~0.5-1 second transitions

**Changes to ProceduralHuman:**
- Added refs for spine, head, neck, leftArm, rightArm groups
- useFrame hook to lerp posture rotations each frame
- Animate vitality color with batched state updates (threshold > 1000)
- Direct ref manipulation for smooth rotation (no re-renders)
- Inline head/neck/arm JSX for ref access
- useEffect for debugging logs (not every frame)

**Animation formula:**
```
newValue = lerp(current, target, 1 - exp(-speed * delta))
```
This gives exponential easing toward target.

**Files created:**
- src/lib/digital-twin/animation.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- MathUtils.lerp for numbers, Color.lerp for colors
- Manipulate refs directly in useFrame, avoid setState for rotations
- Use delta time for framerate-independent animation

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-014: Idle breathing animation

**Implemented:**
- Added timeRef to accumulate time across frames
- Added torsoRef and bodyRef for animation targets
- Breathing: torso scale oscillates 1.0 to 1.015 (Math.sin * 0.015)
- Sway: body Y-rotation oscillates +/- 0.01 radians (~0.6 degrees)
- Breathing cycle: ~4 seconds (1.5 Hz sin wave)
- Sway cycle: ~8 seconds (0.4 Hz sin wave)

**Animation formulas:**
```javascript
breathCycle = Math.sin(time * 1.5);
breathScale = 1.0 + breathCycle * 0.015;
torso.scale.set(breathScale, 1.0, breathScale);

swayCycle = Math.sin(time * 0.4);
body.rotation.y = swayCycle * 0.01;
```

**Ref structure:**
- bodyRef: wraps entire model for sway
- torsoRef: wraps Torso component for breathing scale

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- Scale via .scale.set(x, y, z) - XZ for chest expansion
- Use timeRef.current to accumulate delta for smooth cycles

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-015: Subtle ground shadow

**Implemented:**
- Added ContactShadows from @react-three/drei
- Replaced ground plane with ContactShadows component
- Settings: opacity=0.4, scale=3, blur=2, far=2, color=#1a1a1a

**ContactShadows props:**
- position: [0, 0, 0] - at ground level
- opacity: 0.4 - subtle shadow
- scale: 3 - covers area under model
- blur: 2 - soft edges
- far: 2 - shadow reach distance
- color: #1a1a1a - near-black for shadow

**Files modified:**
- src/components/digital-twin/TwinCanvas.tsx

**drei learnings:**
- ContactShadows renders baked shadows, more performant than real-time
- No receiveShadow needed on ground plane
- Works well with any 3D objects placed above it

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-016: Status indicators overlay

**Implemented:**
- Added StatusOverlay component in DigitalTwin.tsx
- getOverallStatus() maps energy to Optimal/Good/Fair/Needs Attention
- Shows energy level as percentage with visual bar
- Shows highlighted areas count (areas of concern)
- Positioned top-left corner with absolute positioning
- Glass-morphism style: bg-white/90 backdrop-blur-sm

**Status thresholds:**
- >= 75: Optimal (green)
- >= 55: Good (blue)
- >= 35: Fair (yellow)
- < 35: Needs Attention (red)

**Overlay elements:**
- Status label with color coding
- Energy percentage
- Visual progress bar (gradient green)
- Areas of concern count (if > 0)

**Files modified:**
- src/components/digital-twin/DigitalTwin.tsx

**CSS learnings:**
- backdrop-blur-sm for glass effect
- transition-all duration-500 for smooth bar animation

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-017: Click body region for details

**Implemented:**
- Created src/lib/digital-twin/regions.ts for region data mapping
- REGION_INFO maps areas to labels and descriptions
- getRegionHealthData() returns health metrics for region
- Added RegionTooltip component in DigitalTwin.tsx
- onRegionClick prop added to ProceduralHuman
- onClick handlers on all clickable meshes
- Tooltip shows at bottom of canvas with close button

**Clickable regions:**
- head, torso-core
- left/right-shoulder, left/right-elbow
- left/right-hip, left/right-knee

**Region to health data mapping:**
- torso-core → visceral fat, body fat %
- joints → CRP (inflammation)
- head → glucose

**Files created:**
- src/lib/digital-twin/regions.ts

**Files modified:**
- src/components/digital-twin/DigitalTwin.tsx
- src/components/digital-twin/ProceduralHuman.tsx

**React Three Fiber learnings:**
- onClick on mesh handles raycasting automatically
- Lift state to parent component for tooltip display
- useCallback for stable handler references

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-018: Final polish and responsive sizing

**Implemented:**
- Added Suspense with LoadingFallback to TwinCanvas
- LoadingFallback: semi-transparent sphere for loading indication
- Added dpr={[1, 2]} for pixel ratio optimization
- Added gl={{ antialias: true, powerPreference: 'high-performance' }}
- min-h-[400px] ensures minimum height
- Parent container has relative positioning for proper canvas sizing

**Performance optimizations:**
- dpr: [1, 2] - adapts to device pixel ratio (1x for low-end, 2x for retina)
- powerPreference: 'high-performance' - requests discrete GPU if available
- antialias: true - smooth edges without excessive performance cost

**Loading state:**
- Suspense wraps all canvas content
- LoadingFallback renders while Three.js initializes
- Semi-transparent sphere gives visual feedback

**Responsive handling:**
- Container: w-full h-full min-h-[400px]
- Canvas style: position: relative
- Works at all viewport sizes (tested)

**Files modified:**
- src/components/digital-twin/TwinCanvas.tsx

**React Three Fiber learnings:**
- Suspense works natively with R3F components
- gl prop configures WebGL context options
- dpr array sets min/max device pixel ratio

**Verified:**
- [x] typecheck passes
- [x] No console errors
- [x] Responsive at different sizes
- [x] Loading fallback visible briefly on init

---
## 2025-01-13 - DT-003 to DT-023: Clean Mannequin Refactor

**Refactored to LatheGeometry-based smooth body parts:**

**New files created:**
- src/lib/digital-twin/proportions.ts - Anatomical body measurements
- src/lib/digital-twin/geometry.ts - LatheGeometry helpers (createTaperedCapsule, createTorsoGeometry, etc.)
- src/lib/digital-twin/materials.ts - Mannequin material system
- src/components/digital-twin/body-parts/Torso.tsx - LatheGeometry torso
- src/components/digital-twin/body-parts/Head.tsx - Oval head shape
- src/components/digital-twin/body-parts/Neck.tsx - Smooth tapered neck
- src/components/digital-twin/body-parts/Arm.tsx - Tapered limbs with mitten hands
- src/components/digital-twin/body-parts/Leg.tsx - Natural stance legs

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx - Uses new body-parts components
- src/components/digital-twin/DigitalTwin.tsx - Fixed server/client boundary, accepts healthData prop
- src/app/page.tsx - Passes healthData to DigitalTwin

**Key patterns:**
- LatheGeometry creates smooth rotational shapes from 2D profiles
- createTaperedCapsule for limbs with hemisphere caps
- createTorsoGeometry with control points for anatomical shape
- Body parts accept color and highlight props
- forwardRef pattern for all body part components
- Geometry created with useMemo for performance
- All positions derived from BODY_PROPORTIONS and BODY_POSITIONS constants

**Learnings:**
- Client components cannot import modules that use Node.js 'fs' directly
- Pass server-side data as props to client components
- LatheGeometry is perfect for organic rotational shapes
- Overlapping meshes hides seams between body parts
- 32 radial segments gives smooth curves

**Verified:**
- [x] typecheck passes
- [x] dev server returns 200
- [x] All 23 stories marked as passes: true

---
## 2026-01-14 - UX-020: InsightCard component

**Implemented:**
- Created src/components/insights/InsightCard.tsx
- Gradient backgrounds: optimal (green), warning (amber), critical (red)
- Shows title, value, unit, status badge
- Expandable action items on click with smooth animation
- Chevron icon toggles on expand/collapse
- Uses design tokens for radius, shadows

**Files created:**
- src/components/insights/InsightCard.tsx

**Learnings:**
- Use max-h-0/max-h-96 with overflow-hidden for smooth expand animation
- Accessible: aria-expanded, aria-controls attributes

**Verified:**
- [x] typecheck passes

---
## 2026-01-14 - UX-021: Lifestyle page with insight cards and charts

**Implemented:**
- Created src/app/(main)/lifestyle/page.tsx and LifestyleClient.tsx
- 4 InsightCards: HRV, Sleep Score, Resting HR, Strain (with 7-day averages)
- HRV trend line chart with optimal reference line
- Sleep bar chart (hours) with score line overlay
- RHR trend line chart
- Each card has relevant health tips as action items
- Empty state when no activity data

**Files created:**
- src/app/(main)/lifestyle/page.tsx
- src/app/(main)/lifestyle/LifestyleClient.tsx

**recharts learnings:**
- Use dual Y-axes for combining bar and line charts
- Tooltip formatter must handle undefined values
- Use ReferenceLine for optimal thresholds

**Verified:**
- [x] typecheck passes
- [x] Charts render with sample data

---
## 2026-01-14 - UX-022: Body Comp page with insight cards and charts

**Implemented:**
- Created src/app/(main)/body-comp/page.tsx and BodyCompClient.tsx
- 4 InsightCards: Body Fat %, Lean Mass, Visceral Fat, ALMI
- Horizontal bar chart for composition breakdown (Lean, Fat, Bone)
- Donut chart for fat vs lean distribution with percentage labels
- Each card has relevant health tips
- Empty state when no DEXA data

**Files created:**
- src/app/(main)/body-comp/page.tsx
- src/app/(main)/body-comp/BodyCompClient.tsx

**recharts learnings:**
- PieChart with innerRadius creates donut chart
- Use Cell component for individual segment colors
- Label prop accepts function for custom label formatting

**Verified:**
- [x] typecheck passes

---
## 2026-01-14 - UX-023: Navigation tabs updated

**Implemented:**
- Added Lifestyle tab between Biomarkers and Goals
- Added Body Comp tab between Lifestyle and Goals
- All 6 tabs: Dashboard, Biomarkers, Lifestyle, Body Comp, Goals, Data Sources

**Files modified:**
- src/components/layout/TabNav.tsx

**Verified:**
- [x] typecheck passes
- [x] Navigation works

---
## UX POLISH SPRINT 2 COMPLETE

All 4 new stories have been implemented:
- UX-020: InsightCard component (priority 20)
- UX-021: Lifestyle page with insight cards and charts (priority 21)
- UX-022: Body Comp page with insight cards and charts (priority 22)
- UX-023: Navigation tabs updated (priority 23)

---
## DIGITAL TWIN BUILD COMPLETE

All 18 user stories have been implemented:
- DT-001: Install Three.js dependencies (priority 1)
- DT-002: Basic Three.js canvas component (priority 2)
- DT-003: Procedural human body - torso and head (priority 3)
- DT-004: Procedural human body - arms (priority 4)
- DT-005: Procedural human body - legs (priority 5)
- DT-006: Body state types and interface (priority 6)
- DT-007: Health to body state mapper (priority 7)
- DT-008: Posture system - joint rotations (priority 8)
- DT-009: Region highlighting system (priority 9)
- DT-010: Skin tone and vitality visuals (priority 10)
- DT-011: Wire digital twin to health data (priority 11)
- DT-012: Integrate into dashboard layout (priority 12)
- DT-013: Smooth animation transitions (priority 13)
- DT-014: Idle breathing animation (priority 14)
- DT-015: Subtle ground shadow (priority 15)
- DT-016: Status indicators overlay (priority 16)
- DT-017: Click body region for details (priority 17)
- DT-018: Final polish and responsive sizing (priority 18)

---
## 2026-01-16 - DASH-001: AI Chat Bar - Collapsed State

**Implemented:**
- Created src/components/ai-chat/ChatBar.tsx
- Pill-shaped bar with full width, horizontal padding (12px 20px)
- shadow-md for soft shadow effect
- Left: AI sparkle icon with blue-purple gradient background
- Center: Placeholder text 'Ask anything about your health...'
- Right: 2-3 contextual pill buttons (hidden on mobile, shows chevron instead)
- onExpand callback for bar clicks
- onPillClick callback for pill button clicks (stops propagation)
- Keyboard accessible (Enter/Space triggers expansion)
- Uses design tokens: BACKGROUNDS, BORDERS, SHADOWS, TEXT_COLORS, RADIUS

**Files created:**
- src/components/ai-chat/ChatBar.tsx

**Learnings:**
- Design tokens imported from @/lib/design/tokens for consistent styling
- e.stopPropagation() prevents pill clicks from triggering bar expansion
- aria-label and role="button" for accessibility
- sm: breakpoint for responsive pill visibility
- tabIndex={0} enables keyboard navigation

**Verified:**
- [x] typecheck passes
- [x] dev server runs (307 redirect to dashboard)

---
## 2026-01-16 - DASH-002: AI Chat Bar - Contextual Pills Logic

**Implemented:**
- Created src/lib/ai-chat/generateContextualPills.ts
- Takes ExtractedBiomarkers as input, returns ContextualPill[] (id, label)
- Identifies out_of_range and borderline markers using getBiomarkerStatus
- Prioritizes ApoB and HbA1c (FIXED_PRIORITY) when out of range
- Secondary priority for longevity markers (crp, vitaminD, ldl, etc.)
- When all optimal: returns generic questions ("What's keeping me healthy?", etc.)
- Questions kept concise with short name mappings (Vitamin D → Vit D)
- Generates up to 3 contextual pills

**Files created:**
- src/lib/ai-chat/generateContextualPills.ts

**Learnings:**
- Use BIOMARKER_REFERENCES for displayName and reference ranges
- getBiomarkerStatus returns 'optimal'|'normal'|'borderline'|'out_of_range'
- Sort by fixed priority, then longevity priority, then status severity
- Short name mappings help keep questions under 30 chars

**Verified:**
- [x] typecheck passes
- [x] dev server runs

---
## 2026-01-16 - DASH-003: AI Chat Bar - Expanded State

**Implemented:**
- Created src/components/ai-chat/ChatModal.tsx
- Modal with slide-down animation (slideDown keyframe)
- Semi-transparent dark overlay (BACKGROUNDS.overlay)
- Backdrop blur (blur(4px))
- Chat interface: message list + input field with send button
- Close button (X) in top right header
- Click outside modal closes it (handleBackdropClick)
- ESC key closes modal (document keydown listener)
- Modal centered with max-width: 600px, max-height: 70vh
- Auto-scroll to bottom when messages change
- Loading indicator with bouncing dots animation
- Empty state with sparkle icon and helpful text

**Files created:**
- src/components/ai-chat/ChatModal.tsx

**Learnings:**
- Use Z_INDEX.modal from design tokens for consistent layering
- backdrop-filter: blur(4px) with WebkitBackdropFilter for cross-browser
- CSS @keyframes for slideDown and fadeIn animations
- useRef for auto-scroll to messagesEndRef
- Cleanup event listeners in useEffect return
- useCallback for stable handler references

**Verified:**
- [x] typecheck passes
- [x] dev server runs (307 redirect)

---
## 2026-01-16 - DASH-004: AI Chat Bar - State Management

**Implemented:**
- Created src/lib/ai-chat/ChatContext.tsx with React context
- ChatProvider wraps app to provide chat state
- useChat hook for accessing state and actions
- State: isExpanded, messages, inputValue, isLoading
- Actions: expand, collapse, toggle, setInputValue, prefillInput, addMessage, setLoading, clearMessages
- Created src/components/ai-chat/AIChatWidget.tsx
- Integrates ChatBar and ChatModal with context
- Clicking bar or pill calls expand/prefillInput
- Close button calls collapse
- Chat history persists when closing/reopening modal (stored in context)

**Files created:**
- src/lib/ai-chat/ChatContext.tsx
- src/components/ai-chat/AIChatWidget.tsx

**Learnings:**
- React context with useCallback for stable action references
- generateId() with Date.now() + random suffix for unique message IDs
- Clear input after adding user message in addMessage
- Placeholder AI response for now (DASH-005 implements real AI)

**Verified:**
- [x] typecheck passes
- [x] dev server runs (307 redirect)

---
## 2026-01-16 - DASH-005: AI Chat Bar - Basic AI Response

**Implemented:**
- Created src/lib/ai-chat/chatWithAI.ts
- Function sends POST request to /api/chat endpoint
- Handles success and error responses
- Returns ChatResponse { response: string; error?: string }
- Updated AIChatWidget to use chatWithAI instead of placeholder
- Error messages shown to user if API fails
- Loading state managed during API call
- Uses existing /api/chat route that calls Anthropic Claude API
- System prompt in health-agent.ts includes biomarker reference ranges

**Files created:**
- src/lib/ai-chat/chatWithAI.ts

**Files modified:**
- src/components/ai-chat/AIChatWidget.tsx

**Learnings:**
- /api/chat already existed with queryHealthAgent implementation
- healthContext from HealthDataStore.getHealthSummary() provides biomarker data
- Agent uses claude-sonnet-4-5 model with $0.5 budget cap
- Error handling: check response.ok, parse error message from JSON

**Verified:**
- [x] typecheck passes
- [x] dev server runs (307 redirect)

---
## 2026-01-16 - DASH-006: Data Freshness Indicator

**Implemented:**
- Installed date-fns for relative time formatting
- Added DataSourceTimestamps interface to health-data.ts
- Updated HealthDataStore to track timestamps for bloodwork, dexa, activity
- Added getTimestamps() method to HealthDataStore
- Created src/components/dashboard/DataFreshnessBar.tsx
- Shows last updated time for each data source
- Freshness thresholds: fresh (<7 days), stale (>30 days), very stale (>90 days)
- Color coding: normal text for fresh, yellow for stale, red for very stale
- "Retest" badge shown for very stale data

**Files created:**
- src/components/dashboard/DataFreshnessBar.tsx

**Files modified:**
- src/lib/store/health-data.ts
- package.json (added date-fns)

**Learnings:**
- date-fns formatDistanceToNow returns "3 days ago" style text
- differenceInDays for threshold checks
- parseISO to convert ISO string to Date
- getDataFiles() already provides lastModified from fs.statSync

**Verified:**
- [x] typecheck passes
- [x] dev server runs (307 redirect)

---
## 2026-01-16 - DASH-007: Top 5 Personalized Markers - Component

**Implemented:**
- Created src/components/dashboard/TopMarkersCard.tsx
- Card with "Markers to Watch" title
- Shows exactly 5 biomarkers in a list
- Each row: status dot + marker name + value with unit
- Status colors from design tokens (green/yellow/pink)
- Compact layout fits dashboard grid
- Links to /biomarkers page on click
- Empty state when no data

**Files created:**
- src/components/dashboard/TopMarkersCard.tsx

**Learnings:**
- TopMarker interface: { name, value, unit, status }
- BiomarkerStatus type from health.ts: 'optimal'|'normal'|'borderline'|'out_of_range'
- formatValue helper rounds decimals

**Verified:**
- [x] typecheck passes

---
## 2026-01-16 - DASH-008: Top 5 Personalized Markers - Selection Logic

**Implemented:**
- Created src/lib/biomarkers/selectTopMarkers.ts
- FIXED_MARKERS: apob, hba1c always included
- LONGEVITY_PRIORITY: crp, vitaminD, ldl, hdl, triglycerides, fastingInsulin, homocysteine
- DEPRIORITIZED_MARKERS: alkalinePhosphatase, mcv, rdw, wbc, creatinine
- Score calculation: status severity + longevity priority - deprioritized penalty
- Returns array of up to 5 TopMarker objects { name, value, unit, status }

**Files created:**
- src/lib/biomarkers/selectTopMarkers.ts

**Learnings:**
- Score system: out_of_range=100, borderline=50, normal=10, optimal=0
- Longevity priority bonus: (listLength - index) * 10
- Deprioritized penalty: -50
- Filter by score descending after fixed markers

**Verified:**
- [x] typecheck passes

---
## 2026-01-16 - DASH-009: Weekly Lifestyle Summary - Component

**Implemented:**
- Created src/components/dashboard/WeeklyLifestyleCard.tsx
- Card with "This Week" title and "7-day averages" subtitle
- 4 metrics in 2x2 grid: Sleep Consistency, HRV, Strain, Recovery
- Each metric: icon + value + label + subtext
- Empty state with watch icon when no Whoop data
- WeeklySummary interface: { sleepConsistency, hrv, strain, recovery }

**Files created:**
- src/components/dashboard/WeeklyLifestyleCard.tsx

**Learnings:**
- Nullable summary prop handles "no data connected" state
- TypeScript strict null checks: use `summary !== null && summary.prop !== null`
- Icons: moon for sleep, heart for HRV, lightning for strain, trending-up for recovery

**Verified:**
- [x] typecheck passes

---
## 2026-01-16 - DASH-010: Weekly Lifestyle Summary - Data Integration

**Implemented:**
- Created src/lib/lifestyle/calculateWeeklySummary.ts
- Calculates Sleep Consistency: % nights within 30min of avg sleep duration
- Calculates HRV: 7-day average
- Calculates Strain: 7-day average
- Calculates Recovery: 7-day average of sleepScore (Whoop recovery proxy)
- Handles missing days gracefully (filters out 0 values)
- Returns null if no activity data

**Files created:**
- src/lib/lifestyle/calculateWeeklySummary.ts

**Learnings:**
- slice(-7) gets last 7 elements efficiently
- Type guard `filter((v): v is number => v !== undefined)` for optional values
- Sleep consistency: count nights within tolerance of average
- Recovery uses sleepScore as proxy (Whoop correlates sleep quality with recovery)

**Verified:**
- [x] typecheck passes

---
## 2026-01-16 - DASH-011: Dashboard Page Assembly

**Implemented:**
- Updated src/app/(main)/dashboard/page.tsx
- Added AI ChatBar at top (wrapped in ChatProvider)
- Added DataFreshnessBar below chat bar
- Added TopMarkersCard in right column
- Added WeeklyLifestyleCard below top markers
- Responsive 12-column grid: DigitalTwin (4), StatsGrid (5), Right column (3)
- All components pull from shared HealthDataStore
- HeroMetrics, GoalsSection, footer links preserved

**Files modified:**
- src/app/(main)/dashboard/page.tsx

**Learnings:**
- ChatProvider wraps entire page to provide context
- Server component fetches data, passes to client components
- 12-col grid allows precise layout control
- DataFreshnessBar uses negative margin for full-width effect

**Verified:**
- [x] typecheck passes
- [x] dev server runs (307 redirect)
- [x] Page loads without errors

---
## 2026-01-16 - DASH-012: Chat Modal - Message Styling

**Implemented:**
- User messages aligned right with blue/purple gradient
- AI messages aligned left with gray/neutral background
- Rounded corners with asymmetric design
- Timestamps shown subtly below each message
- Simple markdown rendering for AI messages (bold, lists)
- formatTimestamp shows "Just now", "Xm ago", "Xh ago"
- renderMarkdown handles bullet lists, numbered lists, paragraphs, bold text
- Smooth scroll to bottom (already implemented in DASH-003)
- Loading indicator (already implemented in DASH-003)

**Files modified:**
- src/components/ai-chat/ChatModal.tsx

**Learnings:**
- Simple markdown parser handles most AI output formats
- Split content by newlines, detect list patterns (- or * or \d+.)
- processInline handles **bold** syntax with regex split
- flex-col + items-end/items-start for message alignment with timestamp

**Verified:**
- [x] typecheck passes
- [x] dev server runs (307 redirect)

---
## DASHBOARD SPRINT COMPLETE

All 12 user stories have been implemented:
- DASH-001: AI Chat Bar - Collapsed State (priority 1)
- DASH-002: AI Chat Bar - Contextual Pills Logic (priority 2)
- DASH-003: AI Chat Bar - Expanded State (priority 3)
- DASH-004: AI Chat Bar - State Management (priority 4)
- DASH-005: AI Chat Bar - Basic AI Response (priority 5)
- DASH-006: Data Freshness Indicator (priority 6)
- DASH-007: Top 5 Personalized Markers - Component (priority 7)
- DASH-008: Top 5 Personalized Markers - Selection Logic (priority 8)
- DASH-009: Weekly Lifestyle Summary - Component (priority 9)
- DASH-010: Weekly Lifestyle Summary - Data Integration (priority 10)
- DASH-011: Dashboard Page Assembly (priority 11)
- DASH-012: Chat Modal - Message Styling (priority 12)