# HealthAI Build Progress

## Codebase Patterns

<!-- Ralph adds reusable patterns here as discovered -->

---

## Build Log

<!-- Ralph appends completed stories below -->

---
## 2024-01-12 - US-016: Sample data files

**Implemented:**
- Created data/sample-bloodwork.txt with all 9 Levine PhenoAge biomarkers + lipid panel + additional markers
- Created data/sample-dexa.txt with body composition, visceral fat, bone density, ALMI
- Created data/sample-whoop.csv with 7 days of HRV, RHR, sleep data

**Files created:**
- data/sample-bloodwork.txt
- data/sample-dexa.txt
- data/sample-whoop.csv

**Learnings:**
- Bloodwork format: "Biomarker: value unit (Reference: range)" is easy to parse with regex
- DEXA includes multiple T-scores (lumbar, hip, whole body)
- Whoop CSV uses snake_case headers: date,hrv_ms,rhr_bpm,sleep_hours,sleep_score,strain

**Verified:**
- [x] All files exist in /data folder
- [x] Bloodwork contains all 9 PhenoAge inputs: albumin, creatinine, glucose, CRP, lymphocyte %, MCV, RDW, ALP, WBC
- [x] Values realistic for healthy 35-year-old

---
## 2024-01-12 - US-001: Project scaffolding

**Implemented:**
- Next.js 16 app with App Router and src directory
- Tailwind CSS v4 configured
- shadcn/ui initialized with components.json
- TypeScript strict mode enabled
- Added typecheck script to package.json

**Files created:**
- src/app/page.tsx, layout.tsx, globals.css
- src/lib/utils.ts (shadcn)
- tsconfig.json, next.config.ts, postcss.config.mjs
- components.json (shadcn config)
- package.json with scripts

**Learnings:**
- Next.js 16 now uses Turbopack by default
- Tailwind v4 uses different config format (postcss.config.mjs)
- Need to reinstall node_modules after copying from subdirectory (broken symlinks)

**Verified:**
- [x] typecheck passes
- [x] dev server runs (HTTP 200)
- [x] localhost:3000 shows default Next.js page

---
## 2024-01-12 - US-002: Data folder structure and file detection

**Implemented:**
- src/lib/files.ts with getDataFiles() function
- Returns array of {name, type, path, extension} for files in /data
- Type detection based on filename patterns (bloodwork, dexa, activity)
- Supports .txt, .csv, .xlsx extensions
- Console logs detected files on startup

**Files created:**
- src/lib/files.ts

**Learnings:**
- Pattern: Use filename includes() for type detection (blood/lab/metabolic -> bloodwork)
- Return 'unknown' type for unrecognized files
- Log format: "[HealthAI] Detected data files: [...]"

**Verified:**
- [x] typecheck passes
- [x] Console logs: sample-bloodwork.txt (bloodwork), sample-dexa.txt (dexa), sample-whoop.csv (activity)

---
## 2024-01-12 - US-003: Text file parsing

**Implemented:**
- src/lib/parsers/text.ts with parseTextFile(path) function
- Uses fs.readFileSync with utf-8 encoding
- Returns empty string and logs error on failure

**Files created:**
- src/lib/parsers/text.ts

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-004: CSV parsing

**Implemented:**
- Installed papaparse and @types/papaparse
- src/lib/parsers/csv.ts with parseCsv(path) function
- Uses Papa.parse with header: true, dynamicTyping: true
- Returns array of objects with column names as keys

**Files created:**
- src/lib/parsers/csv.ts

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-005: XLSX parsing

**Implemented:**
- Installed xlsx package
- src/lib/parsers/xlsx.ts with parseXlsx(path) function
- Returns array of {name, data} per sheet
- Uses XLSX.utils.sheet_to_json for conversion

**Files created:**
- src/lib/parsers/xlsx.ts

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-006: Biomarker extraction from text

**Implemented:**
- src/lib/extractors/biomarkers.ts with extractBiomarkers(text) function
- Extracts all 9 Levine PhenoAge inputs using regex patterns
- Also extracts lipid panel (LDL, HDL, triglycerides) and vitamin D
- hasAllPhenoAgeInputs() helper to validate required biomarkers
- Handles multiple name variations per biomarker

**Files created:**
- src/lib/extractors/biomarkers.ts

**Learnings:**
- Pattern: Use array of regex patterns per biomarker, first match wins
- Handle variations like "C-Reactive Protein" vs "CRP" vs "hs-CRP"
- Extract patient age from text for PhenoAge calculation

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-007: Levine PhenoAge calculation

**Implemented:**
- src/lib/calculations/phenoage.ts with calculatePhenoAge(biomarkers, chronologicalAge)
- Three-step formula: calculate xb (linear combination), calculate m (mortality risk), calculate PhenoAge
- Returns {phenoAge, delta} or null if missing required biomarkers
- Handles CRP <= 0 edge case by using 0.01
- Rounds to 1 decimal place

**Files created:**
- src/lib/calculations/phenoage.ts

**Learnings:**
- Formula coefficients from Levine et al. (2018) paper
- gamma constant = 0.0077
- Use Math.log for natural log in JavaScript

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-008: Health data store

**Implemented:**
- src/lib/store/health-data.ts with HealthDataStore singleton
- src/lib/extractors/body-comp.ts for DEXA data extraction
- Methods: loadAllData(), getBiomarkers(), getBodyComp(), getActivity(), getPhenoAge(), getHealthSummary()
- Coordinates all parsers and extractors
- getHealthSummary() returns formatted text for agent context

**Files created:**
- src/lib/store/health-data.ts
- src/lib/extractors/body-comp.ts

**Learnings:**
- Singleton pattern: export instance of class
- Lazy loading: ensureLoaded() calls loadAllData() if not loaded
- Activity data averages useful for summary

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-009: Dashboard layout shell

**Implemented:**
- Replaced default Next.js page with HealthAI dashboard
- Header with title, Sync Data button, and age placeholders
- 3-column responsive grid (1 col mobile, 2 col tablet, 3 col desktop)
- Blood Work, DEXA Scan, Activity cards using shadcn/ui
- Areas to Improve section
- Chat section at bottom with placeholder

**Files modified:**
- src/app/page.tsx
- Added src/components/ui/card.tsx (via shadcn)

**Learnings:**
- Tailwind responsive: grid-cols-1 md:grid-cols-2 lg:grid-cols-3
- shadcn Card has CardHeader, CardTitle, CardDescription, CardContent

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-010: Dashboard data integration

**Implemented:**
- src/lib/types/health.ts with reference ranges and status functions
- Dashboard loads real data from HealthDataStore
- Header shows chronological age, biological age, and delta (color-coded)
- Blood Work card displays all biomarkers with color-coded status
- DEXA card shows body composition metrics
- Activity card shows 7-day averages for HRV, RHR, sleep
- Graceful "No data" display when data missing

**Files created:**
- src/lib/types/health.ts

**Files modified:**
- src/app/page.tsx

**Learnings:**
- Reference ranges from HEALTH_KNOWLEDGE.md encoded as constants
- Status logic: check optimal first, then normal, then borderline (10% buffer)
- Color classes: green for optimal/normal, yellow for borderline, red for out of range

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-011: Areas to Improve logic

**Implemented:**
- src/lib/analysis/improvements.ts with getImprovements(biomarkers, bodyComp)
- Returns array of improvements sorted by severity
- Compares against optimal ranges (not just normal)
- Recommendations from HEALTH_KNOWLEDGE.md encoded as constants
- Dashboard renders improvements with color-coded backgrounds
- Shows encouraging message when all biomarkers optimal

**Files created:**
- src/lib/analysis/improvements.ts

**Files modified:**
- src/app/page.tsx

**Learnings:**
- Sort improvements by severity: out_of_range > borderline > normal
- Use getStatusBgColor for card backgrounds
- Target values formatted as ranges or thresholds

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-012: Claude Agent SDK setup

**Implemented:**
- Installed @anthropic-ai/claude-agent-sdk
- Created lib/agent/health-agent.ts with queryHealthAgent() and createHealthAgent()
- Health-focused system prompt with reference ranges, verified sources, response guidelines
- Allowed tools: Read, Bash, WebSearch, WebFetch
- Medical disclaimer included in system prompt
- Handles BetaMessage content extraction properly

**Files created:**
- src/lib/agent/health-agent.ts

**Learnings:**
- SDK returns SDKAssistantMessage with msg.message.content (BetaMessage)
- Content is array of blocks, need to filter for type='text'
- Use permissionMode: 'default' and maxBudgetUsd for safety

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-013: Chat API route

**Implemented:**
- Created app/api/chat/route.ts with POST handler
- Accepts JSON body { message: string }
- Validates message (required, non-empty string)
- Loads health context from HealthDataStore.getHealthSummary()
- Calls queryHealthAgent with message and context
- Returns { response: string } on success
- Error handling: 400 for bad input, 500 for agent errors

**Files created:**
- src/app/api/chat/route.ts

**Learnings:**
- Next.js App Router uses route.ts with exported HTTP method functions
- Use NextRequest/NextResponse for typed request/response

**Verified:**
- [x] typecheck passes
