# HealthAI Build Progress

## Codebase Patterns

<!-- Ralph adds reusable patterns here as discovered -->

---

## Build Log

<!-- Ralph appends completed stories below -->

---
## 2024-01-12 - US-016: Sample data files

**Implemented:**
- Created data/sample-bloodwork.txt with all 9 Levine PhenoAge biomarkers + lipid panel + additional markers
- Created data/sample-dexa.txt with body composition, visceral fat, bone density, ALMI
- Created data/sample-whoop.csv with 7 days of HRV, RHR, sleep data

**Files created:**
- data/sample-bloodwork.txt
- data/sample-dexa.txt
- data/sample-whoop.csv

**Learnings:**
- Bloodwork format: "Biomarker: value unit (Reference: range)" is easy to parse with regex
- DEXA includes multiple T-scores (lumbar, hip, whole body)
- Whoop CSV uses snake_case headers: date,hrv_ms,rhr_bpm,sleep_hours,sleep_score,strain

**Verified:**
- [x] All files exist in /data folder
- [x] Bloodwork contains all 9 PhenoAge inputs: albumin, creatinine, glucose, CRP, lymphocyte %, MCV, RDW, ALP, WBC
- [x] Values realistic for healthy 35-year-old

---
## 2024-01-12 - US-001: Project scaffolding

**Implemented:**
- Next.js 16 app with App Router and src directory
- Tailwind CSS v4 configured
- shadcn/ui initialized with components.json
- TypeScript strict mode enabled
- Added typecheck script to package.json

**Files created:**
- src/app/page.tsx, layout.tsx, globals.css
- src/lib/utils.ts (shadcn)
- tsconfig.json, next.config.ts, postcss.config.mjs
- components.json (shadcn config)
- package.json with scripts

**Learnings:**
- Next.js 16 now uses Turbopack by default
- Tailwind v4 uses different config format (postcss.config.mjs)
- Need to reinstall node_modules after copying from subdirectory (broken symlinks)

**Verified:**
- [x] typecheck passes
- [x] dev server runs (HTTP 200)
- [x] localhost:3000 shows default Next.js page

---
## 2024-01-12 - US-002: Data folder structure and file detection

**Implemented:**
- src/lib/files.ts with getDataFiles() function
- Returns array of {name, type, path, extension} for files in /data
- Type detection based on filename patterns (bloodwork, dexa, activity)
- Supports .txt, .csv, .xlsx extensions
- Console logs detected files on startup

**Files created:**
- src/lib/files.ts

**Learnings:**
- Pattern: Use filename includes() for type detection (blood/lab/metabolic -> bloodwork)
- Return 'unknown' type for unrecognized files
- Log format: "[HealthAI] Detected data files: [...]"

**Verified:**
- [x] typecheck passes
- [x] Console logs: sample-bloodwork.txt (bloodwork), sample-dexa.txt (dexa), sample-whoop.csv (activity)

---
## 2024-01-12 - US-003: Text file parsing

**Implemented:**
- src/lib/parsers/text.ts with parseTextFile(path) function
- Uses fs.readFileSync with utf-8 encoding
- Returns empty string and logs error on failure

**Files created:**
- src/lib/parsers/text.ts

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-004: CSV parsing

**Implemented:**
- Installed papaparse and @types/papaparse
- src/lib/parsers/csv.ts with parseCsv(path) function
- Uses Papa.parse with header: true, dynamicTyping: true
- Returns array of objects with column names as keys

**Files created:**
- src/lib/parsers/csv.ts

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-005: XLSX parsing

**Implemented:**
- Installed xlsx package
- src/lib/parsers/xlsx.ts with parseXlsx(path) function
- Returns array of {name, data} per sheet
- Uses XLSX.utils.sheet_to_json for conversion

**Files created:**
- src/lib/parsers/xlsx.ts

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-006: Biomarker extraction from text

**Implemented:**
- src/lib/extractors/biomarkers.ts with extractBiomarkers(text) function
- Extracts all 9 Levine PhenoAge inputs using regex patterns
- Also extracts lipid panel (LDL, HDL, triglycerides) and vitamin D
- hasAllPhenoAgeInputs() helper to validate required biomarkers
- Handles multiple name variations per biomarker

**Files created:**
- src/lib/extractors/biomarkers.ts

**Learnings:**
- Pattern: Use array of regex patterns per biomarker, first match wins
- Handle variations like "C-Reactive Protein" vs "CRP" vs "hs-CRP"
- Extract patient age from text for PhenoAge calculation

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-007: Levine PhenoAge calculation

**Implemented:**
- src/lib/calculations/phenoage.ts with calculatePhenoAge(biomarkers, chronologicalAge)
- Three-step formula: calculate xb (linear combination), calculate m (mortality risk), calculate PhenoAge
- Returns {phenoAge, delta} or null if missing required biomarkers
- Handles CRP <= 0 edge case by using 0.01
- Rounds to 1 decimal place

**Files created:**
- src/lib/calculations/phenoage.ts

**Learnings:**
- Formula coefficients from Levine et al. (2018) paper
- gamma constant = 0.0077
- Use Math.log for natural log in JavaScript

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-008: Health data store

**Implemented:**
- src/lib/store/health-data.ts with HealthDataStore singleton
- src/lib/extractors/body-comp.ts for DEXA data extraction
- Methods: loadAllData(), getBiomarkers(), getBodyComp(), getActivity(), getPhenoAge(), getHealthSummary()
- Coordinates all parsers and extractors
- getHealthSummary() returns formatted text for agent context

**Files created:**
- src/lib/store/health-data.ts
- src/lib/extractors/body-comp.ts

**Learnings:**
- Singleton pattern: export instance of class
- Lazy loading: ensureLoaded() calls loadAllData() if not loaded
- Activity data averages useful for summary

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-009: Dashboard layout shell

**Implemented:**
- Replaced default Next.js page with HealthAI dashboard
- Header with title, Sync Data button, and age placeholders
- 3-column responsive grid (1 col mobile, 2 col tablet, 3 col desktop)
- Blood Work, DEXA Scan, Activity cards using shadcn/ui
- Areas to Improve section
- Chat section at bottom with placeholder

**Files modified:**
- src/app/page.tsx
- Added src/components/ui/card.tsx (via shadcn)

**Learnings:**
- Tailwind responsive: grid-cols-1 md:grid-cols-2 lg:grid-cols-3
- shadcn Card has CardHeader, CardTitle, CardDescription, CardContent

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-010: Dashboard data integration

**Implemented:**
- src/lib/types/health.ts with reference ranges and status functions
- Dashboard loads real data from HealthDataStore
- Header shows chronological age, biological age, and delta (color-coded)
- Blood Work card displays all biomarkers with color-coded status
- DEXA card shows body composition metrics
- Activity card shows 7-day averages for HRV, RHR, sleep
- Graceful "No data" display when data missing

**Files created:**
- src/lib/types/health.ts

**Files modified:**
- src/app/page.tsx

**Learnings:**
- Reference ranges from HEALTH_KNOWLEDGE.md encoded as constants
- Status logic: check optimal first, then normal, then borderline (10% buffer)
- Color classes: green for optimal/normal, yellow for borderline, red for out of range

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-011: Areas to Improve logic

**Implemented:**
- src/lib/analysis/improvements.ts with getImprovements(biomarkers, bodyComp)
- Returns array of improvements sorted by severity
- Compares against optimal ranges (not just normal)
- Recommendations from HEALTH_KNOWLEDGE.md encoded as constants
- Dashboard renders improvements with color-coded backgrounds
- Shows encouraging message when all biomarkers optimal

**Files created:**
- src/lib/analysis/improvements.ts

**Files modified:**
- src/app/page.tsx

**Learnings:**
- Sort improvements by severity: out_of_range > borderline > normal
- Use getStatusBgColor for card backgrounds
- Target values formatted as ranges or thresholds

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-012: Claude Agent SDK setup

**Implemented:**
- Installed @anthropic-ai/claude-agent-sdk
- Created lib/agent/health-agent.ts with queryHealthAgent() and createHealthAgent()
- Health-focused system prompt with reference ranges, verified sources, response guidelines
- Allowed tools: Read, Bash, WebSearch, WebFetch
- Medical disclaimer included in system prompt
- Handles BetaMessage content extraction properly

**Files created:**
- src/lib/agent/health-agent.ts

**Learnings:**
- SDK returns SDKAssistantMessage with msg.message.content (BetaMessage)
- Content is array of blocks, need to filter for type='text'
- Use permissionMode: 'default' and maxBudgetUsd for safety

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-013: Chat API route

**Implemented:**
- Created app/api/chat/route.ts with POST handler
- Accepts JSON body { message: string }
- Validates message (required, non-empty string)
- Loads health context from HealthDataStore.getHealthSummary()
- Calls queryHealthAgent with message and context
- Returns { response: string } on success
- Error handling: 400 for bad input, 500 for agent errors

**Files created:**
- src/app/api/chat/route.ts

**Learnings:**
- Next.js App Router uses route.ts with exported HTTP method functions
- Use NextRequest/NextResponse for typed request/response

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-014: Chat UI component

**Implemented:**
- Created components/Chat.tsx as client component ('use client')
- Text input field with send button (shadcn Input, Button)
- Message history with alternating user/assistant bubbles
- Loading indicator with bouncing dots animation
- Auto-scroll to latest message using useRef
- Integrated into dashboard page.tsx
- Fetches to /api/chat on submit
- Error handling with inline error display

**Files created:**
- src/components/Chat.tsx
- src/components/ui/input.tsx (via shadcn)
- src/components/ui/button.tsx (via shadcn)

**Files modified:**
- src/app/page.tsx

**Learnings:**
- Use 'use client' for components with React hooks
- useRef for auto-scroll to messagesEndRef div
- Animate loading dots with tailwind animate-bounce and animationDelay

**Verified:**
- [x] typecheck passes

---
## 2024-01-12 - US-015: Data sync on startup and manual resync

**Implemented:**
- App loads data on startup via HealthDataStore lazy loading
- SyncButton client component with loading state
- /api/sync POST endpoint to re-scan /data folder
- Sonner toast for success/error feedback
- Page reloads after successful sync to show updated data
- Layout includes Toaster component

**Files created:**
- src/components/SyncButton.tsx
- src/app/api/sync/route.ts
- src/components/ui/sonner.tsx (via shadcn)

**Files modified:**
- src/app/layout.tsx (add Toaster, update metadata)
- src/app/page.tsx (use SyncButton)

**Learnings:**
- Use sonner for toast notifications (shadcn wrapper)
- Toaster goes in layout.tsx for app-wide availability
- window.location.reload() to refresh server component data

**Verified:**
- [x] typecheck passes

---
## BUILD COMPLETE

All 16 user stories have been implemented:
- US-016: Sample data files (priority 0)
- US-001: Project scaffolding (priority 1)
- US-002: Data folder structure and file detection (priority 2)
- US-003: Text file parsing (priority 3)
- US-004: CSV parsing (priority 4)
- US-005: XLSX parsing (priority 5)
- US-006: Biomarker extraction from text (priority 6)
- US-007: Levine PhenoAge calculation (priority 7)
- US-008: Health data store (priority 8)
- US-009: Dashboard layout shell (priority 9)
- US-010: Dashboard data integration (priority 10)
- US-011: Areas to Improve logic (priority 11)
- US-012: Claude Agent SDK setup (priority 12)
- US-013: Chat API route (priority 13)
- US-014: Chat UI component (priority 14)
- US-015: Data sync on startup and manual resync (priority 15)

---
## 2025-01-13 - DT-001: Install Three.js dependencies

**Implemented:**
- Installed three@0.182.0 for 3D rendering
- Installed @react-three/fiber@9.5.0 for React integration
- Installed @react-three/drei@10.7.7 for helpers (OrbitControls, etc.)
- Installed @types/three@0.182.0 for TypeScript support

**Files modified:**
- package.json (dependencies added)
- package-lock.json

**Three.js learnings:**
- three is the core library
- @react-three/fiber provides React component wrapper for Three.js
- @react-three/drei provides useful helpers like OrbitControls, ContactShadows

**Verified:**
- [x] typecheck passes
- [x] dev server runs without errors

---
## 2025-01-13 - DT-002: Basic Three.js canvas component

**Implemented:**
- Created src/components/digital-twin/TwinCanvas.tsx
- Canvas with soft gray gradient background (CSS linear gradient)
- Three-point lighting: ambient (0.6), directional main (0.8), rim light (0.3)
- OrbitControls with pan disabled, zoom limited, angle constrained
- Camera at [0, 1.5, 4] looking at [0, 1, 0] for human-height view
- Test box mesh for verification
- Semi-transparent ground plane

**Files created:**
- src/components/digital-twin/TwinCanvas.tsx
- src/app/twin-test/page.tsx (test page)

**Three.js learnings:**
- Canvas component needs explicit dimensions (parent container or CSS)
- OrbitControls target sets the focal point for rotation
- minPolarAngle/maxPolarAngle constrains vertical rotation
- Shadow rendering requires castShadow on lights and receiveShadow on meshes

**Verified:**
- [x] typecheck passes
- [x] renders in browser at /twin-test
- [x] gray gradient background visible
- [x] test box renders with proper lighting

---
## 2025-01-13 - DT-003: Procedural human body - torso and head

**Implemented:**
- Created src/components/digital-twin/ProceduralHuman.tsx
- Head as SphereGeometry (radius 0.12)
- Neck as CylinderGeometry connecting head to torso
- Torso as two CapsuleGeometry parts (chest + abdomen)
- Light gray material (#f0f0f0) for mannequin look
- Body positioned so feet will be at Y=0
- castShadow enabled on all meshes

**Files created:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- CapsuleGeometry args: [radius, length, capSegments, radialSegments]
- Use nested groups for hierarchical body parts
- Position offset (bodyOffset) used to ground the figure

**Verified:**
- [x] typecheck passes
- [x] renders in browser
- [x] head, neck, torso visible with proper proportions

---
## 2025-01-13 - DT-004: Procedural human body - arms

**Implemented:**
- Added Arm component with side prop ('left' | 'right')
- Shoulder joint as small sphere
- Upper arm as capsule (radius 0.04, length 0.2)
- Elbow joint as sphere
- Forearm as capsule (radius 0.035, length 0.18)
- Hand as sphere
- Hierarchical grouping: shoulder → upper arm → elbow → forearm → hand
- Arms hang naturally at sides with slight outward angle

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- xSign pattern for mirroring left/right limbs
- Group rotation allows whole limb to rotate from shoulder
- Nested groups enable joint rotations (elbow bends relative to upper arm)

**Verified:**
- [x] typecheck passes
- [x] renders in browser
- [x] both arms visible at sides of torso

---
## 2025-01-13 - DT-005: Procedural human body - legs

**Implemented:**
- Added Leg component with side prop ('left' | 'right')
- Hip joint as sphere
- Thigh as capsule (radius 0.055, length 0.28)
- Knee joint as sphere
- Shin as capsule (radius 0.04, length 0.28)
- Foot as box (flat, extends forward)
- Hierarchical grouping: hip → thigh → knee → shin → foot
- Legs positioned close together under pelvis

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- BoxGeometry for flat feet [width, height, depth]
- Foot offset in Z direction to extend forward naturally
- Full body height ~1.8 units with bodyOffset=0.9

**Verified:**
- [x] typecheck passes
- [x] renders in browser
- [x] full mannequin body visible with proper proportions
- [x] feet touch ground plane

---
## 2025-01-13 - DT-006: Body state types and interface

**Implemented:**
- Created src/lib/digital-twin/types.ts
- BodyState interface: posture, energyLevel, skinTone, highlights
- PostureState type: 'upright' | 'slouched' | 'fatigued' | 'neutral'
- HighlightRegion: { area, color, intensity }
- HighlightArea union type for body regions
- DEFAULT_BODY_STATE constant
- HIGHLIGHT_COLORS and VITALITY_TONES constants
- Updated ProceduralHuman to accept bodyState prop

**Files created:**
- src/lib/digital-twin/types.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- Separating state types from components enables clean data flow
- Console logging body state helps debug health→visual mapping

**Verified:**
- [x] typecheck passes
- [x] renders in browser
- [x] console logs body state

---
## 2025-01-13 - DT-007: Health to body state mapper

**Implemented:**
- Created src/lib/digital-twin/mapper.ts
- mapHealthToBodyState(healthData) function
- calculateAverageSleepScore() - from activity data or sleep hours
- calculateAverageHrv() - from activity data
- calculateEnergyLevel() - weighted 60% sleep, 40% HRV
- determinePosture() - maps energy/HRV to PostureState
- determineSkinTone() - maps energy to VITALITY_TONES
- calculateHighlights() - visceral fat→torso, CRP→joints

**Thresholds:**
- Visceral fat: >2.0 critical, >1.5 warning, >1.0 mild
- CRP: >3.0 critical (all joints), >2.0 warning (knees), >1.0 mild
- Energy: ≥75 upright, ≥55 neutral, ≥35 slouched, <35 fatigued

**Files created:**
- src/lib/digital-twin/mapper.ts

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-008: Posture system - joint rotations

**Implemented:**
- Created src/lib/digital-twin/posture.ts
- getPostureRotations(energyLevel, postureState) function
- Returns: spineX, neckX, shoulderZ, headX in radians
- Posture presets for upright/neutral/slouched/fatigued
- getArmRotations(energyLevel) for shoulder adjustment
- Updated ProceduralHuman to apply rotations
- Added rotation props to Head, Neck, Arm components
- Test page with energy slider to demo posture changes

**Rotation values (radians):**
- Upright: 0 on all axes
- Fatigued: spineX=0.25, neckX=0.18, headX=0.15, shoulderZ=0.12

**Files created:**
- src/lib/digital-twin/posture.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx
- src/app/twin-test/page.tsx

**Three.js learnings:**
- Group rotation affects all children (spine rotation cascades)
- Separate upper body rotation from legs for realistic posture

**Verified:**
- [x] typecheck passes
- [x] posture rotations calculated correctly

---
## 2025-01-13 - DT-009: Region highlighting system

**Implemented:**
- Created src/lib/digital-twin/highlights.ts
- BODY_REGIONS mapping areas to component names
- getHighlightForRegion() - finds highlight for area
- getEmissiveProps() - returns emissive color and intensity
- isRegionHighlighted() - checks if area is highlighted
- getMaterialProps() helper in ProceduralHuman
- Added highlights prop to Torso, Arm, Leg components
- Emissive materials applied to: torso, shoulders, elbows, hips, knees

**Highlight areas:**
- torso-core, left/right-shoulder, left/right-elbow
- left/right-hip, left/right-knee, head

**Files created:**
- src/lib/digital-twin/highlights.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- meshStandardMaterial accepts emissive (color) and emissiveIntensity (0-1)
- Spread props: {...materialProps} applies all properties

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-010: Skin tone and vitality visuals

**Implemented:**
- Created src/lib/digital-twin/vitality.ts
- getVitalityColor(energyLevel) - calculates HSL-based color from energy
- hslToHex() helper for HSL to hex conversion
- lerp() helper for linear interpolation
- VITALITY_PRESETS for quick reference colors

**Color mapping:**
- High energy (100): warm white hsl(30, 10%, 92%)
- Low energy (0): cool gray hsl(220, 5%, 80%)
- Smooth interpolation between values

**Changes to ProceduralHuman:**
- Import getVitalityColor from vitality.ts
- Calculate vitalityColor based on energyLevel
- Pass vitalityColor to all sub-components (Head, Neck, Torso, Arm, Leg)
- All body parts now use vitality color as base material color

**Files created:**
- src/lib/digital-twin/vitality.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**HSL learnings:**
- HSL easier than RGB for intuitive color manipulation
- Hue 30 = warm/orange, Hue 220 = cool/blue
- Small saturation changes (5-10%) keep mannequin look

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-011: Wire digital twin to health data

**Implemented:**
- Created src/components/digital-twin/DigitalTwin.tsx
- Main wrapper that connects HealthDataStore to ProceduralHuman
- Uses useMemo to compute bodyState from health data
- Calls mapHealthToBodyState with biomarkers, bodyComp, activity
- Console logs health input and mapped state for debugging
- Falls back to DEFAULT_BODY_STATE on error

**Data flow:**
HealthDataStore → HealthDataInput → mapHealthToBodyState → BodyState → ProceduralHuman

**Files created:**
- src/components/digital-twin/DigitalTwin.tsx

**Learnings:**
- useMemo for expensive computations that don't change often
- Error handling with fallback state for robustness

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-012: Integrate into dashboard layout

**Implemented:**
- Added DigitalTwin import to main page.tsx
- Created 2-column grid layout (lg breakpoint)
- Twin on left (lg:row-span-2), stats cards on right
- Twin container: min-h-[400px] aspect-[4/5]
- Stats cards in responsive sub-grid
- Mobile stacks vertically

**Layout structure:**
- Main grid: lg:grid-cols-2
- Digital Twin card spans 2 rows on lg
- Stats cards (Blood Work, DEXA, Activity) stacked on right
- Areas to Improve and Chat sections below

**Files modified:**
- src/app/page.tsx

**CSS learnings:**
- lg:row-span-2 makes twin tall enough for stats cards
- aspect-[4/5] maintains proportions without content shift
- min-h-[400px] ensures minimum visibility

**Verified:**
- [x] typecheck passes

---
## 2025-01-13 - DT-013: Smooth animation transitions

**Implemented:**
- Created src/lib/digital-twin/animation.ts
- lerpValue() - smooth number interpolation using exponential decay
- lerpPosture() - animate all posture rotations together
- lerpColor() - smooth Three.js Color interpolation
- AnimatedPosture interface for type-safe animation state
- ANIMATION_SPEED constant (2.0) for ~0.5-1 second transitions

**Changes to ProceduralHuman:**
- Added refs for spine, head, neck, leftArm, rightArm groups
- useFrame hook to lerp posture rotations each frame
- Animate vitality color with batched state updates (threshold > 1000)
- Direct ref manipulation for smooth rotation (no re-renders)
- Inline head/neck/arm JSX for ref access
- useEffect for debugging logs (not every frame)

**Animation formula:**
```
newValue = lerp(current, target, 1 - exp(-speed * delta))
```
This gives exponential easing toward target.

**Files created:**
- src/lib/digital-twin/animation.ts

**Files modified:**
- src/components/digital-twin/ProceduralHuman.tsx

**Three.js learnings:**
- MathUtils.lerp for numbers, Color.lerp for colors
- Manipulate refs directly in useFrame, avoid setState for rotations
- Use delta time for framerate-independent animation

**Verified:**
- [x] typecheck passes
